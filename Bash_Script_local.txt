export PATH=/home/sratoolkit.2.10.7-ubuntu64/bin:$PATH;
export PATH=/home/samtools-1.10:$PATH;
mkdir lineages;
mkdir coverage;
mkdir consensus;
mkdir depth;

count=0
for I in $(cat /home/run_ids.txt);do
if [ $count == 0 ]; then
esearch -db sra -query ${I} | efetch -format runinfo > covars.csv
else
esearch -db sra -query ${I} | efetch -format runinfo | sed -n 2p >> covars.csv;
fi
count=1
mkdir $I; 
prefetch $I;
cd $I;
fasterq-dump $I.sra;
rm $I.sra;
cd ..;
conda activate artic-ncov2019; 
mkdir $I/filtered; 
artic guppyplex --min-length 400 --max-length 700 --directory $I --prefix $I --output $I/filtered/$I.fastq;
cd $I/filtered
artic minion --medaka --normalise 200 --threads 4 --scheme-directory /home/artic-ncov2019/primer_schemes --read-file $I/filtered/$I.fastq nCoV-2019/V3 "$I";
cd ../..;
scp $I/filtered/$I.consensus.fasta consensus 
conda activate pangolin; 
samtools coverage $I/filtered/$I.sorted.bam -o coverage/"$I"_coverage.txt;
samtools depth $I/filtered/$I.sorted.bam -o depth/"$I"_depth.txt;
pangolin $I/filtered/$I.consensus.fasta --outfile lineages/"$I"_lineage.csv; 
done

augur align --sequences consensus/*.fasta --reference-sequence /home/artic-ncov2019/primer_schemes/nCoV-2019/V3/nCoV-2019.reference.fasta --output consensus/msa.fasta



